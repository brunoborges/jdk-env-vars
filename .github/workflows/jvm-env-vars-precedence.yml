name: JVM Env Var Precedence

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  matrix-run:
    name: Run script (JDK ${{ matrix.java }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java: [8, 11, 17, 21]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}

      - name: Make script executable
        run: chmod +x ./check-jvm-env-vars.sh

      - name: Run script (JSON)
        run: |
          ./check-jvm-env-vars.sh -p ciProp -j -q --no-color > result.json
          echo "Result JSON:" && cat result.json

      - name: Upload JSON artifact
        uses: actions/upload-artifact@v4
        with:
          name: precedence-json-jdk-${{ matrix.java }}
          path: result.json

  aggregate:
    name: Aggregate Report
    needs: [matrix-run]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download all JSON artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Make aggregation script executable
        run: chmod +x ./aggregate-report.sh

      - name: Generate aggregated markdown report
        run: ./aggregate-report.sh artifacts REPORT.md

      - name: Upload aggregated report artifact
        uses: actions/upload-artifact@v4
        with:
            name: aggregated-report
            path: REPORT.md

      - name: Commit & push REPORT.md (main branch only)
        if: github.ref == 'refs/heads/main'
        run: |
          # Fetch existing report if present
          cp REPORT.md ci-REPORT.md
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          if [ -f REPORT.md ]; then
            :
          fi
          git add REPORT.md
          git diff --cached --quiet || git commit -m "ci: update precedence REPORT.md [skip ci]"
          git push || echo "Non-fast-forward push skipped (likely PR context)"
